---

.build::template:
  extends: .template
  variables:
    REGISTRY: $CI_REGISTRY_IMAGE
  before_script: &build-template-before_script
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - apk update && apk upgrade
    - apk add --no-cache bash jq
  after_script: &build-template-after_script
    - docker logout $CI_REGISTRY

.build::slurm:
  extends: .build::template
  variables:
    REGISTRY: $CI_REGISTRY_IMAGE/$ARCH
    BAKE_TARGET: all
    BAKE_IMPORTS: --file docker-bake.hcl --file $VERSION/$FLAVOR/slurm.hcl
  tags:
    - schedmd-slc
    - linux/$ARCH
  parallel:
    matrix:
      - VERSION: &build-versions
          - master
          - '25.05'
          - '24.11'
          - '24.05'
        FLAVOR: &build-flavors
          - rockylinux9
          - ubuntu24.04
        ARCH:
          - amd64
          - arm64
  script:
    - cd ./schedmd/slurm/
    - docker buildx bake $BAKE_IMPORTS --print $BAKE_TARGET
    - docker buildx bake $BAKE_IMPORTS --progress=plain --push $BAKE_TARGET
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && $VERSION == 'master'
      changes:
        - schedmd/slurm/**
      allow_failure: true
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        - schedmd/slurm/**

build::slurm:
  extends: .build::slurm

# TODO: https://gitlab.com/gitlab-org/gitlab/-/issues/423553
build::manifest:
  extends: .build::slurm
  stage: manifest
  variables:
    REGISTRY: $CI_REGISTRY_IMAGE
  tags:
    - schedmd-slc
  parallel:
    matrix:
      - VERSION: *build-versions
        FLAVOR: *build-flavors
  script:
    - ./schedmd/slurm/manifest.sh --push --amd64 --arm64

################################################################################

.release::template:
  extends: .template
  stage: release
  variables:
    REGISTRY: $DOCKER_REGISTRY
  before_script:
    - *build-template-before_script
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - |
      if [ -z $DOCKER_REGISTRY_PASSWORD ] || [ -z $DOCKER_REGISTRY ] || [ -z $DOCKER_REGISTRY_USER ]; then
        echo "Runner lacks login info. Either environment variables are not defined, or runner is on an unprotected branch/tag.";
        exit 1;
      fi
    - echo "$DOCKER_REGISTRY_PASSWORD" | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
  after_script:
    - *build-template-after_script
    - docker logout $DOCKER_REGISTRY

.release::slurm:
  extends: .release::template
  variables:
    REGISTRY: $DOCKER_REGISTRY/$ARCH
    BAKE_TARGET: all
    BAKE_IMPORTS: --file docker-bake.hcl --file $VERSION/$FLAVOR/slurm.hcl
  tags:
    - schedmd-slc
    - linux/$ARCH
  parallel:
    matrix:
      - VERSION: &release-versions
          - '25.05'
          - '24.11'
          - '24.05'
        FLAVOR: &release-flavors
          - rockylinux9
          - ubuntu24.04
        ARCH:
          - amd64
          - arm64
  script:
    - cd ./schedmd/slurm/
    - docker buildx bake $BAKE_IMPORTS --print $BAKE_TARGET
    - docker buildx bake $BAKE_IMPORTS --progress=plain --push $BAKE_TARGET
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - schedmd/slurm/**
        - .gitlab-ci.yml
        - .gitlab/ci/**/*.yml

release::slurm:
  extends: .release::slurm

# TODO: https://gitlab.com/gitlab-org/gitlab/-/issues/423553
release::manifest:
  extends: .release::slurm
  stage: manifest
  tags:
    - schedmd-slc
  parallel:
    matrix:
      - VERSION: *release-versions
        FLAVOR: *release-flavors
  script:
    - ./schedmd/slurm/manifest.sh --push --amd64 --arm64
