---

pre-commit:
  extends: .template
  stage: check
  before_script:
    - docker info
    - apk update && apk upgrade
    - apk add --no-cache pre-commit shellcheck shfmt
  script:
    - pre-commit run --all-files --show-diff-on-failure --verbose

docker-bake-check:
  extends: .template
  stage: check
  variables:
    BAKE_IMPORTS: --file docker-bake.hcl --file $VERSION/$FLAVOR/slurm.hcl
  parallel:
    matrix:
      - VERSION:
          - master
          - '25.11'
          - '25.05'
        FLAVOR:
          - rockylinux9
          - ubuntu24.04
  script:
    - cd ./schedmd/slurm/
    - docker bake $BAKE_IMPORTS --progress=plain --check core
    - docker bake $BAKE_IMPORTS --progress=plain --check extras
  rules:
    - changes:
        - schedmd/slurm/**/*
      allow_failure: true # https://github.com/docker/buildx/issues/3343
